<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Map Camera Web</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: #000;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }
        #camera-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }
        #camera-view, #photo-result {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #controls {
            padding: 10px;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        button {
            padding: 0;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #capture-btn {
            background: #fff;
            color: #000;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
        }
        #overlay-container {
            position: absolute;
            bottom: 80px;
            left: 10px;
            right: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            backdrop-filter: blur(2px);
        }
        #map-thumbnail {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 120px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid white;
            overflow: hidden;
            z-index: 10;
        }
        #photo-canvas {
            display: none;
        }
        .overlay-text {
            margin-bottom: 5px;
        }
        .address-line {
            font-weight: bold;
            margin-bottom: 8px;
        }
        #saving-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
            z-index: 200;
        }
        @media (min-width: 768px) {
            #controls {
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                width: auto;
                background: transparent;
                border-radius: 30px;
            }
            #map-thumbnail {
                width: 150px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="camera-container">
            <video id="camera-view" autoplay playsinline></video>
            <canvas id="photo-canvas"></canvas>
            <img id="photo-result" style="display:none;">
            <div id="overlay-container">
                <div class="address-line" id="address-text"></div>
                <div class="overlay-text" id="coordinates-text"></div>
                <div class="overlay-text" id="time-text"></div>
                <div class="overlay-text" id="accuracy-text"></div>
            </div>
            <div id="map-thumbnail"></div>
        </div>
        <div id="controls">
            <button id="toggle-camera" title="Switch Camera">üîÑ</button>
            <button id="capture-btn" title="Capture">üì∑</button>
            <button id="upload-btn" title="Upload">üìÅ</button>
        </div>
        <div id="saving-indicator">Saving photo...</div>
    </div>

    <script>
        // Initialize variables
        let cameraStream = null;
        let currentCamera = 'environment';
        let map;
        let marker;
        let currentLocation = null;
        let photoData = [];
        let addressInfo = "Location not available";
        const GOOGLE_MAPS_API_KEY = 'AIzaSyBxiP-VOE5ROHLNKnZRwJEYpbKtZmHtWa0';

        // DOM Elements
        const cameraView = document.getElementById('camera-view');
        const photoCanvas = document.getElementById('photo-canvas');
        const photoResult = document.getElementById('photo-result');
        const captureBtn = document.getElementById('capture-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const toggleCameraBtn = document.getElementById('toggle-camera');
        const overlayContainer = document.getElementById('overlay-container');
        const addressText = document.getElementById('address-text');
        const coordinatesText = document.getElementById('coordinates-text');
        const timeText = document.getElementById('time-text');
        const accuracyText = document.getElementById('accuracy-text');
        const mapThumbnail = document.getElementById('map-thumbnail');
        const savingIndicator = document.getElementById('saving-indicator');

        // Initialize the application
        async function initApp() {
            await initCamera();
            loadGoogleMapsAPI();
            startLocationTracking();
            
            // Set up event listeners
            captureBtn.addEventListener('click', captureAndSavePhoto);
            uploadBtn.addEventListener('click', uploadPhoto);
            toggleCameraBtn.addEventListener('click', toggleCamera);
        }

        // Load Google Maps API
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // Initialize Google Map
        function initMap() {
            map = new google.maps.Map(mapThumbnail, {
                zoom: 15,
                center: { lat: 0, lng: 0 },
                disableDefaultUI: true,
                zoomControl: false,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: false,
                gestureHandling: 'none'
            });

            marker = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#ff0000"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(24, 24),
                    anchor: new google.maps.Point(12, 24)
                }
            });
        }

        // Initialize camera
        async function initCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraView.srcObject = cameraStream;
            } catch (err) {
                console.error("Camera error: ", err);
                alert("Could not access the camera. Please check permissions.");
            }
        }

        // Start tracking location
        function startLocationTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    async position => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp)
                        };
                        
                        // Try to get address information using Google Geocoding
                        try {
                            const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${currentLocation.lat},${currentLocation.lng}&key=${GOOGLE_MAPS_API_KEY}`);
                            const data = await response.json();
                            if (data.results && data.results.length > 0) {
                                addressInfo = data.results[0].formatted_address;
                            }
                        } catch (e) {
                            console.error("Geocoding error:", e);
                            // Fallback to OpenStreetMap
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}`);
                                const data = await response.json();
                                if (data.address) {
                                    addressInfo = formatAddress(data);
                                }
                            } catch (e2) {
                                console.error("Fallback geocoding error:", e2);
                            }
                        }
                        
                        updateLocationOverlay();
                        updateMap();
                    },
                    error => {
                        console.error("Geolocation error: ", error);
                        addressText.textContent = "Location: Not available";
                    },
                    { enableHighAccuracy: true, maximumAge: 10000 }
                );
            } else {
                addressText.textContent = "Geolocation is not supported";
            }
        }

        // Format address from Nominatim response (fallback)
        function formatAddress(data) {
            const addr = data.address;
            let parts = [];
            
            if (addr.house_number && addr.road) {
                parts.push(`${addr.house_number}, ${addr.road}`);
            } else if (addr.road) {
                parts.push(addr.road);
            }
            if (addr.suburb) parts.push(addr.suburb);
            if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
            if (addr.state) parts.push(addr.state);
            if (addr.country) parts.push(addr.country);
            
            return parts.join(", ");
        }

        // Update location text overlay
        function updateLocationOverlay() {
            if (currentLocation) {
                const dateStr = currentLocation.timestamp.toLocaleString();
                addressText.textContent = addressInfo;
                coordinatesText.textContent = `Lat ${currentLocation.lat.toFixed(6)}¬∞ Long ${currentLocation.lng.toFixed(6)}¬∞`;
                timeText.textContent = dateStr;
                accuracyText.textContent = `Accuracy: ${currentLocation.accuracy.toFixed(0)} meters`;
            }
        }

        // Update Google Map position
        function updateMap() {
            if (currentLocation && map && marker) {
                const position = { lat: currentLocation.lat, lng: currentLocation.lng };
                map.setCenter(position);
                marker.setPosition(position);
            }
        }

        // Capture and save photo
        async function captureAndSavePhoto() {
            if (!cameraStream) return;
            
            try {
                // Show saving indicator
                savingIndicator.style.display = 'block';
                
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = cameraView.videoWidth;
                photoCanvas.height = cameraView.videoHeight;
                
                // Draw camera view to canvas
                context.drawImage(cameraView, 0, 0, photoCanvas.width, photoCanvas.height);
                
                // Add overlay to the canvas
                await addOverlayToCanvas(context);
                
                // Create filename with timestamp
                const dateStr = new Date().toISOString()
                    .replace(/[:.]/g, '-')
                    .replace('T', '_')
                    .substring(0, 19);
                
                // Save the photo automatically
                const imageData = photoCanvas.toDataURL('image/jpeg');
                savePhotoToDevice(imageData, `geo_photo_${dateStr}.jpg`);
                
                // Store photo data
                photoData.push({
                    imageData: imageData,
                    location: currentLocation,
                    address: addressInfo,
                    timestamp: new Date()
                });
                
                // Briefly show the captured photo
                photoResult.src = imageData;
                photoResult.style.display = 'block';
                cameraView.style.display = 'none';
                
                // Hide after 1 second
                setTimeout(() => {
                    photoResult.style.display = 'none';
                    cameraView.style.display = 'block';
                }, 1000);
                
            } catch (error) {
                console.error("Error capturing/saving photo:", error);
                alert("Error saving photo. Please try again.");
            } finally {
                savingIndicator.style.display = 'none';
            }
        }

        // Add overlay information to the canvas
        async function addOverlayToCanvas(ctx) {
            if (!currentLocation) return;
            
            const canvas = ctx.canvas;
            const dateStr = new Date().toLocaleString();
            
            // Draw semi-transparent background for text
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            const textHeight = 100;
            ctx.fillRect(0, canvas.height - textHeight, canvas.width, textHeight);
            
            // Draw text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textBaseline = 'top';
            
            const lines = [
                addressInfo,
                `Lat ${currentLocation.lat.toFixed(6)}¬∞ Long ${currentLocation.lng.toFixed(6)}¬∞`,
                dateStr,
                `Accuracy: ${currentLocation.accuracy.toFixed(0)} meters`
            ];
            
            let y = canvas.height - textHeight + 10;
            const lineHeight = 20;
            
            lines.forEach((line, i) => {
                if (i === 0) {
                    ctx.font = 'bold 18px Arial';
                } else {
                    ctx.font = '16px Arial';
                }
                ctx.fillText(line, 10, y);
                y += lineHeight;
            });
            
            // Draw map thumbnail using Google Static Maps API
            if (currentLocation) {
                try {
                    const mapWidth = 120;
                    const mapHeight = 80;
                    const zoom = 15;
                    
                    // Create Google Static Maps URL
                    const staticMapUrl = `https://maps.googleapis.com/maps/api/staticmap?` +
                        `center=${currentLocation.lat},${currentLocation.lng}&` +
                        `zoom=${zoom}&` +
                        `size=${mapWidth}x${mapHeight}&` +
                        `markers=color:red%7C${currentLocation.lat},${currentLocation.lng}&` +
                        `key=${GOOGLE_MAPS_API_KEY}`;
                    
                    // Create and load map image
                    const mapImage = new Image();
                    mapImage.crossOrigin = 'anonymous';
                    
                    await new Promise((resolve, reject) => {
                        mapImage.onload = () => {
                            // Draw the map image
                            ctx.drawImage(mapImage, canvas.width - 130, 10, mapWidth, mapHeight);
                            
                            // Draw border around map
                            ctx.strokeStyle = 'white';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(canvas.width - 130, 10, mapWidth, mapHeight);
                            
                            resolve();
                        };
                        
                        mapImage.onerror = () => {
                            console.error("Failed to load Google Static Map");
                            drawMapFallback(ctx, canvas);
                            resolve();
                        };
                        
                        // Load the map image
                        mapImage.src = staticMapUrl;
                    });
                    
                } catch (error) {
                    console.error("Error rendering map thumbnail:", error);
                    drawMapFallback(ctx, canvas);
                }
            }
        }

        // Enhanced fallback map drawing function
        function drawMapFallback(ctx, canvas) {
            const mapWidth = 120;
            const mapHeight = 80;
            const x = canvas.width - 130;
            const y = 10;
            
            // Draw background
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(x, y, mapWidth, mapHeight);
            
            // Draw some roads/paths
            ctx.strokeStyle = '#cbd5e0';
            ctx.lineWidth = 2;
            
            // Horizontal roads
            ctx.beginPath();
            ctx.moveTo(x, y + 25);
            ctx.lineTo(x + mapWidth, y + 25);
            ctx.moveTo(x, y + 55);
            ctx.lineTo(x + mapWidth, y + 55);
            ctx.stroke();
            
            // Vertical roads
            ctx.beginPath();
            ctx.moveTo(x + 30, y);
            ctx.lineTo(x + 30, y + mapHeight);
            ctx.moveTo(x + 90, y);
            ctx.lineTo(x + 90, y + mapHeight);
            ctx.stroke();
            
            // Draw some building blocks
            ctx.fillStyle = '#a0aec0';
            ctx.fillRect(x + 10, y + 10, 15, 10);
            ctx.fillRect(x + 45, y + 35, 20, 15);
            ctx.fillRect(x + 75, y + 15, 12, 8);
            ctx.fillRect(x + 35, y + 60, 18, 12);
            
            // Draw location marker
            ctx.fillStyle = '#e53e3e';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('üìç', x + (mapWidth/2) - 12, y + (mapHeight/2) + 8);
            
            // Draw coordinates
            ctx.fillStyle = '#2d3748';
            ctx.font = 'bold 9px Arial';
            ctx.fillText(`${currentLocation.lat.toFixed(3)}, ${currentLocation.lng.toFixed(3)}`, 
                        x + 5, y + mapHeight - 5);
            
            // Draw border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, mapWidth, mapHeight);
        }

        // Save photo to device
        function savePhotoToDevice(dataUrl, fileName) {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Upload existing photo
        function uploadPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async event => {
                        // Create image to get dimensions
                        const img = new Image();
                        img.onload = async () => {
                            // Set canvas dimensions
                            photoCanvas.width = img.width;
                            photoCanvas.height = img.height;
                            
                            // Draw image to canvas
                            const ctx = photoCanvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            
                            // Add overlay
                            await addOverlayToCanvas(ctx);
                            
                            // Save the photo automatically
                            const imageData = photoCanvas.toDataURL('image/jpeg');
                            savePhotoToDevice(imageData, `geo_upload_${new Date().getTime()}.jpg`);
                            
                            // Store photo data
                            photoData.push({
                                imageData: imageData,
                                location: currentLocation,
                                address: addressInfo,
                                timestamp: new Date()
                            });
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        }

        // Toggle between front and back camera
        async function toggleCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            await initCamera();
            
            if (photoResult.style.display === 'block') {
                photoResult.style.display = 'none';
                cameraView.style.display = 'block';
            }
        }

        // Global function for Google Maps callback
        window.initMap = initMap;

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
